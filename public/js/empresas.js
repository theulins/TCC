let rows=[]; const q=document.getElementById('q'); q.addEventListener('input',render); async function load(){ const r=await fetch('/api/companies',{headers:authHeaders()}); rows=await r.json(); render(); } function render(){ const term=(q.value||'').toLowerCase(); const tb=document.querySelector('#tbl tbody'); tb.innerHTML=''; rows.filter(r=>(r.fantasy_name||'').toLowerCase().includes(term)||(r.cnpj||'').includes(term)).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.fantasy_name||''}</td><td>${r.cnpj||''}</td><td>${r.city||''}/${r.state||''}</td><td>${new Date(r.updated_at).toLocaleString('pt-BR')}</td><td><button class='badge' data-pdf='${r.id}'>PDF</button><a class='badge' href='/empresa_edit.html?id=${r.id}'>Editar</a></td>`; tb.appendChild(tr); }); tb.querySelectorAll('button[data-pdf]').forEach(btn=>{ btn.addEventListener('click', async ()=>{ const id=btn.getAttribute('data-pdf'); const r=await fetch(`/api/companies/${id}/pdf?token=${encodeURIComponent(getToken())}`); if(!r.ok){ const e=await r.json().catch(()=>({error:'Erro PDF'})); return toast(e.error||'Erro PDF'); } const b=await r.blob(); const url=URL.createObjectURL(b); window.open(url,'_blank'); }); }); } load();